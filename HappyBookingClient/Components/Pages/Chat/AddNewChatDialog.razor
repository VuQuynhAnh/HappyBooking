@using Blazored.LocalStorage
@using HappyBookingClient.Service.IService
@using HappyBookingShare.Common
@using HappyBookingShare.Request.Chat
@using HappyBookingShare.Request.Chat.RequestItem
@using HappyBookingShare.Request.User
@using HappyBookingShare.Response.Dtos
@inject ILanguageService _languageService
@inject IUserService _userService
@inject IChatService _chatService
@inject ILocalStorageService _localStorage

<style>
    .addNewChatDialog {
        min-width: 370px;
    }

        .addNewChatDialog .mud-dialog-content {
            height: 420px;
        }

        .addNewChatDialog .mud-table-root .mud-table-head {
            display: none;
        }

        .addNewChatDialog .mud-table {
            border-radius: 0;
        }

        .addNewChatDialog .mud-elevation-1 {
            box-shadow: none;
        }

        .addNewChatDialog .mud-table-cell {
            padding: 1px 0 0 5px;
            border: none;
        }

        .addNewChatDialog .userSelectedList {
            max-height: 150px;
            overflow-y: auto;
        }

        .addNewChatDialog .mud-table-root {
            background: #ffffe6;
        }

        .addNewChatDialog .userSelectedList .mud-table-root {
            background: #e6ffe6;
        }

        .addNewChatDialog .mud-button-text-size-large {
            padding: 14px 0px;
        }
</style>
<MudDialog Class="addNewChatDialog">
    <DialogContent>
        <MudTextField @bind-Value="memberSearchKeyWord"
                      Placeholder="@_languageService["Search"]"
                      Variant="Variant.Outlined"
                      Adornment="Adornment.End"
                      AdornmentIcon="@Icons.Material.Filled.Search"
                      DebounceInterval="850"
                      OnKeyUp="@KeyUpAction"
                      OnDebounceIntervalElapsed="SearchAction"
                      Class="searchBoxStyle my-2" />

        <MudDataGrid Items="@userFilterList"
                     T="UserDto"
                     Filterable="false"
                     SortMode="@SortMode.None"
                     Groupable="false"
                     Virtualize="true"
                     FixedHeader="true"
                     Height="200px">
            <Columns>
                <TemplateColumn>
                    <CellTemplate>
                        <MudBadge Color="context.Item.IsOnline ? Color.Success : Color.Error" Overlap="true" Bordered="true">
                            <MudAvatar>
                                <MudImage Src="@context.Item.AvatarImage" />
                            </MudAvatar>
                        </MudBadge>
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn>
                    <CellTemplate>
                        <MudText Typo="Typo.subtitle1">@context.Item.FullName</MudText>
                        <MudText Typo="Typo.subtitle2">@context.Item.PhoneNumber</MudText>
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn CellClass="d-flex justify-end">
                    <CellTemplate>
                        <MudStack Row>
                            <MudButton Size="@Size.Large"
                                       Variant="@Variant.Text"
                                       Color="@Color.Success"
                                       EndIcon="@Icons.Material.Filled.Add"
                                       OnClick="(() => AddUserToGroupChat(context.Item))" />
                        </MudStack>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
        </MudDataGrid>

        <MudDivider Class="my-2" />

        <div class="userSelectedList">
            <MudDataGrid Items="@userSelectedList"
                         Filterable="false"
                         Virtualize="true"
                         FixedHeader="true"
                         SortMode="@SortMode.None"
                         Groupable="false">
                <Columns>
                    <TemplateColumn>
                        <CellTemplate>
                            <MudBadge Color="context.Item.IsOnline ? Color.Success : Color.Error" Overlap="true" Bordered="true">
                                <MudAvatar>
                                    <MudImage Src="@context.Item.AvatarImage" />
                                </MudAvatar>
                            </MudBadge>
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn>
                        <CellTemplate>
                            <MudText Typo="Typo.subtitle1">@context.Item.FullName</MudText>
                            <MudText Typo="Typo.subtitle2">@context.Item.PhoneNumber</MudText>
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn CellClass="d-flex justify-end">
                        <CellTemplate>
                            <MudStack Row>
                                <MudButton Size="@Size.Large"
                                           Variant="@Variant.Text"
                                           Color="@Color.Error"
                                           EndIcon="@Icons.Material.Outlined.Cancel"
                                           OnClick="(() => RemoveUserToGroupChat(context.Item))" />
                            </MudStack>
                        </CellTemplate>
                    </TemplateColumn>
                </Columns>
            </MudDataGrid>
        </div>

    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Primary"
                   OnClick="StartChat">
            @_languageService["StartChat"]
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private MudDialogInstance MudDialog { get; set; }

    private string memberSearchKeyWord = string.Empty;
    private List<UserDto> userSelectedList = new();
    private List<UserDto> userFilterList = new();
    private UserDto userLogin = new();
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await _languageService.LoadLanguage();
            userLogin = await _localStorage.GetItemAsync<UserDto>(KeyConstant.UserLogin) ?? new();
            StateHasChanged();
        }
    }

    private async Task KeyUpAction(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SearchAction("");
        }
    }

    private async Task SearchAction(string debouncedText)
    {
        userFilterList.Clear();
        if (!string.IsNullOrEmpty(memberSearchKeyWord))
        {
            GetListUserRequest request = new()
                {
                    KeyWord = memberSearchKeyWord,
                    PageIndex = 1,
                    PageSize = 15,
                };
            var resposeSearch = await _userService.GetAllUserData(request);
            userFilterList = (resposeSearch?.Data ?? new())
                             .Where(item => !userSelectedList.Select(selected => selected.UserId).Contains(item.UserId)
                                            && userLogin.UserId != item.UserId)
                             .ToList();
        }
    }

    private async Task StartChat()
    {
        if (!userSelectedList.Any())
        {
            return;
        }
        var groupName = userLogin.FullName + "-" + string.Join("-", userSelectedList.Select(item => item.FullName));
        List<ChatMemberRequestItem> memberItemList = userSelectedList.Select(item => new ChatMemberRequestItem(item.UserId, 0)).ToList();
        memberItemList.Add(new ChatMemberRequestItem(userLogin.UserId, 0));

        SaveChatGroupRequest saveChatGroupRequest = new()
            {
                ChatId = 0,
                Name = groupName,
                AvatarUrl = string.Empty,
                IsGroup = memberItemList.Count > 2,
                ChatMemberList = memberItemList
            };
        var saveChatResponse = await _chatService.SaveChatGroupAsync(saveChatGroupRequest);
        MudDialog.Close(DialogResult.Ok(saveChatResponse?.Data.ChatId ?? 0));
    }

    private void AddUserToGroupChat(UserDto user)
    {
        if (userSelectedList.Any(item => item.UserId == user.UserId))
        {
            return;
        }
        userSelectedList.Add(user);
        userFilterList = userFilterList.Where(item => !userSelectedList.Contains(item)).ToList();
        StateHasChanged();
    }

    private void RemoveUserToGroupChat(UserDto user)
    {
        if (userSelectedList.Any(item => item.UserId == user.UserId))
        {
            userSelectedList.Remove(user);
            StateHasChanged();
        }
    }
}